#include <boards/board_config.h>
#include <drivers/adc.h>
#include <drivers/ntc.h>
#include <stdint.h>

#define NTC_LUT_SIZE 166

struct ntc_point {
	uint16_t x;
	int8_t y;
};

static const struct ntc_point ntc_lookup_table[NTC_LUT_SIZE] = {
	{.x = 297, .y = 125},  {.x = 303, .y = 124},  {.x = 310, .y = 123},
	{.x = 316, .y = 122},  {.x = 323, .y = 121},  {.x = 330, .y = 120},
	{.x = 337, .y = 119},  {.x = 345, .y = 118},  {.x = 352, .y = 117},
	{.x = 360, .y = 116},  {.x = 368, .y = 115},  {.x = 376, .y = 114},
	{.x = 384, .y = 113},  {.x = 393, .y = 112},  {.x = 402, .y = 111},
	{.x = 411, .y = 110},  {.x = 420, .y = 109},  {.x = 429, .y = 108},
	{.x = 439, .y = 107},  {.x = 449, .y = 106},  {.x = 459, .y = 105},
	{.x = 469, .y = 104},  {.x = 480, .y = 103},  {.x = 491, .y = 102},
	{.x = 502, .y = 101},  {.x = 513, .y = 100},  {.x = 525, .y = 99},
	{.x = 537, .y = 98},   {.x = 549, .y = 97},   {.x = 562, .y = 96},
	{.x = 574, .y = 95},   {.x = 588, .y = 94},   {.x = 601, .y = 93},
	{.x = 615, .y = 92},   {.x = 629, .y = 91},   {.x = 644, .y = 90},
	{.x = 658, .y = 89},   {.x = 673, .y = 88},   {.x = 689, .y = 87},
	{.x = 704, .y = 86},   {.x = 721, .y = 85},   {.x = 737, .y = 84},
	{.x = 754, .y = 83},   {.x = 771, .y = 82},   {.x = 789, .y = 81},
	{.x = 807, .y = 80},   {.x = 825, .y = 79},   {.x = 844, .y = 78},
	{.x = 863, .y = 77},   {.x = 883, .y = 76},   {.x = 903, .y = 75},
	{.x = 924, .y = 74},   {.x = 945, .y = 73},   {.x = 966, .y = 72},
	{.x = 988, .y = 71},   {.x = 1010, .y = 70},  {.x = 1033, .y = 69},
	{.x = 1056, .y = 68},  {.x = 1080, .y = 67},  {.x = 1104, .y = 66},
	{.x = 1128, .y = 65},  {.x = 1153, .y = 64},  {.x = 1179, .y = 63},
	{.x = 1205, .y = 62},  {.x = 1231, .y = 61},  {.x = 1258, .y = 60},
	{.x = 1285, .y = 59},  {.x = 1314, .y = 58},  {.x = 1342, .y = 57},
	{.x = 1371, .y = 56},  {.x = 1401, .y = 55},  {.x = 1431, .y = 54},
	{.x = 1461, .y = 53},  {.x = 1492, .y = 52},  {.x = 1523, .y = 51},
	{.x = 1555, .y = 50},  {.x = 1587, .y = 49},  {.x = 1619, .y = 48},
	{.x = 1652, .y = 47},  {.x = 1685, .y = 46},  {.x = 1718, .y = 45},
	{.x = 1752, .y = 44},  {.x = 1786, .y = 43},  {.x = 1821, .y = 42},
	{.x = 1856, .y = 41},  {.x = 1891, .y = 40},  {.x = 1926, .y = 39},
	{.x = 1962, .y = 38},  {.x = 1997, .y = 37},  {.x = 2033, .y = 36},
	{.x = 2070, .y = 35},  {.x = 2106, .y = 34},  {.x = 2142, .y = 33},
	{.x = 2179, .y = 32},  {.x = 2216, .y = 31},  {.x = 2253, .y = 30},
	{.x = 2290, .y = 29},  {.x = 2327, .y = 28},  {.x = 2364, .y = 27},
	{.x = 2401, .y = 26},  {.x = 2438, .y = 25},  {.x = 2474, .y = 24},
	{.x = 2511, .y = 23},  {.x = 2548, .y = 22},  {.x = 2584, .y = 21},
	{.x = 2620, .y = 20},  {.x = 2656, .y = 19},  {.x = 2692, .y = 18},
	{.x = 2728, .y = 17},  {.x = 2763, .y = 16},  {.x = 2798, .y = 15},
	{.x = 2833, .y = 14},  {.x = 2868, .y = 13},  {.x = 2902, .y = 12},
	{.x = 2935, .y = 11},  {.x = 2969, .y = 10},  {.x = 3002, .y = 9},
	{.x = 3034, .y = 8},   {.x = 3066, .y = 7},   {.x = 3098, .y = 6},
	{.x = 3129, .y = 5},   {.x = 3159, .y = 4},   {.x = 3189, .y = 3},
	{.x = 3219, .y = 2},   {.x = 3248, .y = 1},   {.x = 3276, .y = 0},
	{.x = 3304, .y = -1},  {.x = 3332, .y = -2},  {.x = 3359, .y = -3},
	{.x = 3385, .y = -4},  {.x = 3411, .y = -5},  {.x = 3436, .y = -6},
	{.x = 3460, .y = -7},  {.x = 3484, .y = -8},  {.x = 3508, .y = -9},
	{.x = 3530, .y = -10}, {.x = 3552, .y = -11}, {.x = 3574, .y = -12},
	{.x = 3594, .y = -13}, {.x = 3615, .y = -14}, {.x = 3634, .y = -15},
	{.x = 3653, .y = -16}, {.x = 3672, .y = -17}, {.x = 3690, .y = -18},
	{.x = 3707, .y = -19}, {.x = 3724, .y = -20}, {.x = 3740, .y = -21},
	{.x = 3756, .y = -22}, {.x = 3771, .y = -23}, {.x = 3786, .y = -24},
	{.x = 3800, .y = -25}, {.x = 3814, .y = -26}, {.x = 3827, .y = -27},
	{.x = 3839, .y = -28}, {.x = 3852, .y = -29}, {.x = 3863, .y = -30},
	{.x = 3875, .y = -31}, {.x = 3885, .y = -32}, {.x = 3896, .y = -33},
	{.x = 3906, .y = -34}, {.x = 3915, .y = -35}, {.x = 3924, .y = -36},
	{.x = 3933, .y = -37}, {.x = 3942, .y = -38}, {.x = 3950, .y = -39},
	{.x = 3957, .y = -40},
};

int8_t ntc_read_celsius(void)
{
	static uint32_t i = 0;
	adc_device *adc = adc_get_device(NTC_ADC);
	uint16_t adc_raw_value = (uint16_t)adc_read_raw(adc, NTC_ADC_CHANNEL);

	/* As temperature changes slowly, chances are the new value is a neighbour */
	if (adc_raw_value >= ntc_lookup_table[i + 1].x) {
		while (i < (NTC_LUT_SIZE - 1) && (adc_raw_value > ntc_lookup_table[i].x)) {
			i++;
		}
	} else if (adc_raw_value <= ntc_lookup_table[i - 1].x) {
		while ((i > 0) && (adc_raw_value < ntc_lookup_table[i].x)) {
			i--;
		}
	}

	return ntc_lookup_table[i].y;
}
